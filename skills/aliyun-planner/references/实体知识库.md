# 实体知识库 (Entity Knowledge Base)

## 文档摘要

本文档定义了阿里云云资源查询场景下的完整实体知识体系，旨在为自然语言查询（NLQ）中的实体识别、归一化、验证和关系理解提供结构化支持。知识库包含八大核心模块，覆盖从基础定义到用户建模的全生命周期。

## 1. 实体类型定义库 (Entity Type Definitions)

### 1.1 核心实体类型清单

**服务级实体 (Service-Level Entities)**

| 实体代码 | 正式名称 | 英文名称 | 描述 | 资源类型示例 | 典型标识符前缀 |
|---|---|---|---|---|---|
| ECS | 弹性计算服务 | Elastic Compute Service | 提供可扩展的计算能力，包括云服务器、弹性裸金属等 | Instance, Disk, Image, Snapshot, SecurityGroup | i-, d-, m-, s-, sg- |
| RDS | 关系型数据库服务 | Relational Database Service | 提供稳定可靠、可弹性伸缩的关系型数据库服务 | DBInstance, Database, Account, Backup | rm-, db- |
| Redis | 云数据库 Redis 版 | ApsaraDB for Redis | 提供兼容 Redis 协议的内存数据库服务 | Instance, Account, Backup, ParameterGroup | r-, am- |
| MongoDB | 云数据库 MongoDB 版 | ApsaraDB for MongoDB | 提供基于 MongoDB 的文档数据库服务 | DBInstance, Database, Account, Backup | ds-, rs- |
| PolarDB | 云数据库 PolarDB | PolarDB |下一代关系型数据库，支持 MySQL/PostgreSQL/Oracle 兼容 | DBInstance, Database, Account, Backup | pc-, gp- |
| SLB | 负载均衡 | Server Load Balancer | 将访问流量分发到多台后端服务器，扩展应用系统服务能力 | LoadBalancer, Listener, BackendServer | lb-, lsn- |
| ALB | 应用型负载均衡 | Application Load Balancer | 面向网络层和应用层的负载均衡服务，支持基于内容的高级路由 | LoadBalancer, Listener, Rule, ServerGroup, BackendServer | alb-, lsn-, rsg- |
| VPC | 专有网络 | Virtual Private Cloud | 在阿里云上自定义逻辑隔离的私有网络环境 | VPC, VSwitch, RouteTable, NATGateway | vpc-, vsw-, rt-, ngw- |
| OSS | 对象存储服务 | Object Storage Service | 提供海量、安全、低成本、高可靠的云存储服务 | Bucket, Object | 无固定前缀，bucket名全局唯一 |
| NAS | 文件存储 NAS | File Storage NAS | 提供可共享访问的文件存储服务 | FileSystem, MountTarget, Snapshot | 无固定前缀 |
| FC | 函数计算 | Function Compute | 事件驱动的全托管计算服务 | Service, Function, Trigger, Alias | 无固定前缀 |
| EIP | 弹性公网IP | Elastic IP Address | 独立的公网IP资源，可绑定到云服务器、负载均衡等 | EipAddress | eip- |
| ACK | 容器服务 | Container Service for Kubernetes | 支持Kubernetes的容器化应用管理平台 | Cluster, NodePool, Application | c-, np- |
| DNS | 云解析DNS | Alibaba Cloud DNS | 提供权威DNS和递归DNS服务 | Domain, Record | 无固定前缀 |
| RocketMQ | 消息队列 RocketMQ 版 | Message Queue RocketMQ | 高可靠、高并发、可扩展的消息队列服务 | Instance, Group, Topic, Subscription | MQInst- |
| Kafka | 消息队列 Kafka 版 | Message Queue Kafka | 分布式、高吞吐量的消息队列服务 | Instance, Topic, Group, Consumer | alikafka- |
| SLS | 日志服务 | Log Service | 提供日志采集、查询、分析、投递等服务 | Project, Logstore, Logtail, Dashboard | 无固定前缀 |
| CMS | 云监控 | CloudMonitor | 监控云产品和服务，提供告警和可视化 | Alarm, Metric, Dashboard, Group | 无固定前缀 |
| WAF | Web应用防火墙 | Web Application Firewall | 保护网站免受常见 Web 攻击 | Domain, Instance, Policy | 无固定前缀 |
| DDoS | DDoS 防护 | Anti-DDoS | 防护 DDoS 攻击，保护业务正常运行 | Instance, Policy | ddos-, bgp- |

**复合实体类型 (Composite Entity Types)**

| 实体代码 | 描述 | 组成元素 | 示例查询 |
|---|---|---|---|
| CLUSTER | 逻辑集群（自定义分组） | 同一业务或应用的一组资源（跨服务） | “我的电商集群包含哪些资源？” |
| ENVIRONMENT | 环境（如生产、测试） | 通过标签（env:prod）标识的资源集合 | “生产环境的所有ECS” |
| APPLICATION | 应用（如订单服务） | 实现特定功能的一组资源（ECS+RDS+SLB） | “订单服务的架构拓扑” |
| PROJECT | 项目（财务或管理单元） | 通过标签或资源组划分的资源集合 | “项目A本月花了多少钱？” |

### 1.2 实体层级与继承关系

资源 (Resource)
├── 云服务 (Cloud Service)
│   ├── 计算 (Compute)
│   │   ├── ECS Instance
│   │   │   ├── ECS Disk (系统盘/数据盘)
│   │   │   ├── ECS Image
│   │   │   └── ECS Snapshot
│   │   └── SecurityGroup
│   ├── 数据库 (Database)
│   │   ├── 关系型数据库
│   │   │   ├── RDS Instance
│   │   │   │   ├── RDS Database
│   │   │   │   ├── RDS Account
│   │   │   │   └── RDS Backup
│   │   │   └── PolarDB Instance
│   │   │       ├── PolarDB Database
│   │   │       ├── PolarDB Account
│   │   │       └── PolarDB Backup
│   │   ├── NoSQL数据库
│   │   │   ├── Redis Instance
│   │   │   │   ├── Redis Account
│   │   │   │   └── Redis Backup
│   │   │   └── MongoDB Instance
│   │   │       ├── MongoDB Database
│   │   │       ├── MongoDB Account
│   │   │       └── MongoDB Backup
│   ├── 存储 (Storage)
│   │   ├── 对象存储
│   │   │   └── OSS Bucket
│   │   │       └── OSS Object
│   │   └── 文件存储
│   │       └── NAS FileSystem
│   │           ├── MountTarget
│   │           └── NAS Snapshot
│   ├── Serverless
│   │   └── 函数计算 FC
│   │       ├── FC Service
│   │       ├── FC Function
│   │       ├── FC Trigger
│   │       └── FC Alias
│   ├── 消息队列 (Message Queue)
│   │   ├── RocketMQ Instance
│   │   │   ├── RocketMQ Topic
│   │   │   ├── RocketMQ Group
│   │   │   └── RocketMQ Subscription
│   │   └── Kafka Instance
│   │       ├── Kafka Topic
│   │       ├── Kafka Partition
│   │       └── Kafka Consumer Group
│   ├── 容器服务
│   │   └── ACK Cluster
│   │       ├── ACK Node
│   │       ├── ACK Pod
│   │       └── ACK Service
│   ├── 网络 (Network)
│   │   ├── VPC (专有网络)
│   │   │   ├── VSwitch (虚拟交换机)
│   │   │   ├── RouteTable (路由表)
│   │   │   └── NATGateway (NAT网关)
│   │   ├── 负载均衡
│   │   │   ├── SLB (传统负载均衡)
│   │   │   │   ├── SLB LoadBalancer
│   │   │   │   └── SLB Listener
│   │   │   └── ALB (应用负载均衡)
│   │   │       ├── ALB LoadBalancer
│   │   │       ├── ALB Listener
│   │   │       ├── ALB Rule
│   │   │       └── ALB ServerGroup
│   │   └── 公网访问
│   │       └── EIP (弹性公网IP)
│   ├── 域名与 DNS
│   │   └── DNS Domain
│   │       └── DNS Record
│   ├── 日志与监控
│   │   ├── SLS (日志服务)
│   │   │   ├── SLS Project
│   │   │   ├── SLS Logstore
│   │   │   └── SLS Dashboard
│   │   └── CMS (云监控)
│   │       ├── CMS Alarm
│   │       ├── CMS Metric
│   │       └── CMS Dashboard
│   └── 安全服务
│       ├── WAF (Web应用防火墙)
│       │   ├── WAF Domain
│       │   └── WAF Policy
│       └── DDoS (DDoS防护)
│           ├── DDoS Instance
│           └── DDoS Policy
├── 配置项 (Configuration Item)
│   ├── SecurityGroup Rule
│   ├── VSwitch Rule
│   ├── DNS Record
│   ├── WAF Policy Rule
│   └── DDoS Policy Rule
└── 元资源 (Meta Resource)
    ├── Tag (标签)
    ├── Resource Group (资源组)
    ├── RAM Role (访问角色)
    ├── Certificate (SSL/TLS证书)
    └── AccessKey (访问密钥)

## 2. 实体标识符模式库 (Identifier Patterns)

### 2.1 标准标识符格式（正则表达式）

**阿里云通用资源ID模式**

| 资源类型 | 标识符字段 | 正则模式 | 示例 | 说明 |
|---|---|---|---|---|
| ECS实例 | InstanceId | i-[a-z0-9]{17} | i-uf6f5g7e8d9c0b1a2 | 固定前缀i-，后跟17位小写字母数字 |
| ECS云盘 | DiskId | d-[a-z0-9]{17} | d-uf6f5g7e8d9c0b1a2 | 固定前缀d- |
| 安全组 | SecurityGroupId | sg-[a-z0-9]{17} | sg-uf6f5g7e8d9c0b1a2 | 固定前缀sg- |
| RDS实例 | DBInstanceId | rm-[a-z0-9]{17} | rm-uf6f5g7e8d9c0b1a2 | 固定前缀rm- |
| VPC | VpcId | vpc-[a-z0-9]{17} | vpc-uf6f5g7e8d9c0b1a2 | 固定前缀vpc- |
| VSwitch | VSwitchId | vsw-[a-z0-9]{17} | vsw-uf6f5g7e8d9c0b1a2 | 固定前缀vsw |
| SLB实例 | LoadBalancerId | lb-[a-z0-9]{17} | lb-uf6f5g7e8d9c0b1a2 | 固定前缀lb- |
| ALB实例 | LoadBalancerId | alb-[a-z0-9]{17} | alb-uf6f5g7e8d9c0b1a2 | 固定前缀alb- |
| ALB服务器组 | ServerGroupId | rsg-[a-z0-9]{17} | rsg-uf6f5g7e8d9c0b1a2 | 固定前缀rsg- |
| EIP | AllocationId | eip-[a-z0-9]{17} | eip-uf6f5g7e8d9c0b1a2 | 固定前缀eip- |
| Redis实例 | InstanceId | r-[a-z0-9]{17} | r-uf6f5g7e8d9c0b1a2 | 固定前缀r- |
| MongoDB实例 | DBInstanceId | ds-[a-z0-9]{17} | ds-uf6f5g7e8d9c0b1a2 | 固定前缀ds- |
| PolarDB实例 | DBInstanceId | pc-[a-z0-9]{17} | pc-uf6f5g7e8d9c0b1a2 | 固定前缀pc- |
| RocketMQ实例 | InstanceId | MQInst-[a-z0-9]{17} | MQInst-uf6f5g7e8d9c0b1a2 | 固定前缀MQInst- |
| Kafka实例 | InstanceId | alikafka_post-[a-z0-9]{17} | alikafka_post-uf6f5g7e8d9c0b1a2 | 固定前缀alikafka_post- |
| DDoS防护实例 | InstanceId | ddos-[a-z0-9]{17} | ddos-uf6f5g7e8d9c0b1a2 | 固定前缀ddos- |

**名称模式（用户自定义）**

| 模式类型 | 正则模式 | 示例 | 常见场景 |
|---|---|---|---|
| 业务命名 | [a-zA-Z0-9\-_]{2,64} | web-server-01, prod-db-master | 按角色-环境-序号命名 |
| 标签模式 | [a-zA-Z0-9_.:/=+@-]{1,128} | env:prod, project:game-2025 | 标签键值对 |
| IP地址 | IPv4标准模式 | 192.168.1.1, 10.0.0.1 | 内网IP，公网IP |
| 域名 | 标准域名模式 | www.example.com, api.service.alibaba | 云解析域名 |

### 2.2 标识符提取策略

**策略优先级**
1. 精确ID匹配：优先匹配标准资源ID格式（如i-xxx）
2. 名称匹配：在指定服务范围内匹配资源名称
3. 标签匹配：通过标签键值对定位资源
4. IP/域名匹配：通过网络标识定位
5. 上下文推断：基于会话历史或默认值推断

**模糊标识符处理**

| 用户输入模式 | 提取策略 | 示例输入 → 提取结果 |
|---|---|---|
| 部分ID | 前缀匹配 + 列表过滤 | i-123 → 匹配所有以i-123开头的实例ID |
| 仅名称关键词 | 名称包含匹配 + 标签辅助 | web服务器 → 查找名称包含`web`或标签`role:web`的ECS |
| 角色描述 | 标签映射 + 业务规则 | 数据库主节点 → 查找标签`role:master`且服务为RDS的资源 |
| 位置描述 | 地域 + 服务类型推断 | 北京的数据库 → 地域`cn-beijing`，服务`RDS` |

## 3. 同义词与映射库 (Synonyms & Mapping)

### 3.1 服务同义词映射表

**ECS服务**

| 正式术语 | 常见同义词 | 用户口语表达 | 业务场景映射 |
|---|---|---|---|
| ECS实例 | 云服务器，虚拟机，云主机，计算实例，服务器，主机，机器，VM | "我的网站服务器"， "应用服务器"， "那台测试机" | web服务器 → 标签`role:web`<br>数据库服务器 → 高内存规格，标签`role:db` |
| 系统盘 | 根磁盘，启动盘，OS磁盘 | "系统盘"， "C盘" | - |
| 数据盘 | 存储盘，附加磁盘，数据磁盘 | "数据盘"， "D盘"， "挂载的硬盘" | - |
| 安全组 | 防火墙，网络策略，安全策略，访问控制 | "防火墙规则"， "入站规则" | - |
| 镜像 | 系统镜像，模板，快照（误用） | "系统镜像"， "安装模板" | - |

**ALB服务**

| 正式术语 | 常见同义词 | 用户口语表达 | 业务场景映射 |
|---|---|---|---|
| ALB实例 | 应用负载均衡，七层负载均衡，应用负载均衡器，ALB | "我的应用负载均衡"， "七层负载均衡"， "HTTP负载均衡" | web应用负载均衡 → 协议HTTP/HTTPS<br>微服务网关 → 基于路径的路由规则 |
| 服务器组 | 后端服务器组，服务器组，后端组 | "服务器组"， "后端服务器" | - |
| 监听器 | 监听，端口监听，监听配置 | "80端口监听"， "HTTPS监听" | - |
| 转发规则 | 路由规则，转发规则，转发策略 | "转发规则"， "路由配置" | 基于路径路由 → /api → API服务组<br>基于域名路由 → api.example.com |

**ACL 关联查询特殊说明**

| 正式术语 | API 要求 | 说明 |
|---|---|---|
| ALB ACL 关联关系查询 | ListAclRelations | ALB 监听器的 ACL 关联无法通过监听器属性直接获取，必须调用专门的 ListAclRelations API |
| SLB ACL 关联关系查询 | DescribeLoadBalancer*ListenerAttribute | SLB 的 ACL 关联信息存储在监听器属性中（AclId 字段），可直接通过监听器属性查询 |
| ACL 条目详情 | ListAclEntries | 查询 ACL 内的 IP/CIDR 条目详情 |

**RDS服务**

| 正式术语 | 常见同义词 | 用户口语表达 | 数据库引擎映射 |
|---|---|---|---|
| RDS实例 | 云数据库，数据库实例，数据库服务器，DB | “MySQL数据库”， “PostgreSQL实例”， “我的数据库” | MySQL → Engine=MySQL<br>pg → Engine=PostgreSQL<br>sqlserver → Engine=SQLServer |
| 数据库 | 库，Schema，数据表集合 | “数据库”， “库”， “业务库” | - |
| 账号 | 用户，登录账号，DB用户 | “数据库账号”， “登录用户” | - |
| 备份 | 快照，数据备份，备份集 | “数据库备份”， “昨晚的备份” | - |

**Redis服务**

| 正式术语 | 常见同义词 | 用户口语表达 | 业务场景映射 |
|---|---|---|---|
| Redis实例 | 缓存实例，Redis缓存，内存数据库 | “我的Redis”， “缓存服务器”， “Redis集群” | 会话缓存 → Session存储<br>消息队列 → Pub/Sub<br>分布式锁 → 分布式协调 |
| 缓存 | Cache | “缓存”， “Cache” | - |

**MongoDB服务**

| 正式术语 | 常见同义词 | 用户口语表达 | 业务场景映射 |
|---|---|---|---|
| MongoDB实例 | 文档数据库，MongoDB数据库，NoSQL数据库 | “我的Mongo”， “文档数据库”， “MongoDB集群” | 文档存储 → JSON文档<br>日志存储 → 日志归档<br>内容管理 → CMS后端 |

**PolarDB服务**

| 正式术语 | 常见同义词 | 用户口语表达 | 业务场景映射 |
|---|---|---|---|
| PolarDB实例 | PolarDB数据库，云原生数据库 | “我的PolarDB”， “PolarDB集群” | 高并发场景 → 读写分离<br>海量数据 → 分布式存储 |

**消息队列服务**

| 正式术语 | 常见同义词 | 用户口语表达 | 业务场景映射 |
|---|---|---|---|
| RocketMQ实例 | 消息队列，MQ，RocketMQ集群 | “消息队列”， “MQ服务器”， “RocketMQ” | 异步解耦 → 系统间通信<br>流量削峰 → 限时抢购 |
| Kafka实例 | Kafka集群，Kafka服务 | “Kafka”， “Kafka集群” | 日志收集 → 日志聚合<br>流式处理 → 实时数据分析 |
| Topic | 主题，消息主题 | “Topic”， “消息主题” | - |
| Consumer Group | 消费者组，消费组 | “消费组”， “消费者组” | - |

**函数计算服务**

| 正式术语 | 常见同义词 | 用户口语表达 | 业务场景映射 |
|---|---|---|---|
| FC函数 | 函数，云函数，Serverless函数 | “我的函数”， “云函数”， “FC函数” | 事件驱动 → OSS触发<br>定时任务 → Cron触发 |
| FC服务 | 函数服务，Function Compute服务 | “函数服务”， “FC服务” | - |
| 触发器 | Trigger，触发器 | “触发器”， “Trigger” | - |

**存储服务**

| 正式术语 | 常见同义词 | 用户口语表达 | 业务场景映射 |
|---|---|---|---|
| OSS存储桶 | Bucket，OSS桶，对象存储 | “我的OSS”， “Bucket”， “存储桶” | 图片存储 → 静态资源<br>文件备份 → 数据归档 |
| NAS文件系统 | 文件存储，NAS，共享存储 | “NAS”， “文件系统”， “共享存储” | 持久化存储 → 容器共享目录<br>文件共享 → 多服务器共享 |

**日志与监控服务**

| 正式术语 | 常见同义词 | 用户口语表达 | 业务场景映射 |
|---|---|---|---|
| SLS日志服务 | 日志服务，Log Service | “日志服务”， “SLS” | 日志采集 → 应用日志<br>日志分析 → SQL查询 |
| Logstore | 日志库，日志存储 | “Logstore”， “日志库” | - |
| CMS云监控 | 云监控，监控服务 | “云监控”， “监控” | 告警 → 阈值告警<br>监控大盘 → 可视化监控 |

**安全服务**

| 正式术语 | 常见同义词 | 用户口语表达 | 业务场景映射 |
|---|---|---|---|
| WAF防火墙 | Web防火墙，Web应用防火墙 | “WAF”， “Web防火墙” | Web防护 → SQL注入防护<br>防攻击 → CC攻击防护 |
| DDoS防护 | DDoS防护，DDoS高防 | “DDoS”， “DDoS防护” | 防攻击 → DDoS攻击防护 |

### 3.2 地域同义词映射表

| 地域ID | 正式名称 | 常用简称 | 用户口语 |
|---|---|---|---|
| cn-hangzhou | 华东1（杭州） | 杭州，华东，华东区域 | “杭州机房”， “华东节点” |
| cn-beijing | 华北2（北京） | 北京，华北，北方 | “北京机房”， “华北区域” |
| cn-shanghai | 华东2（上海） | 上海，华东 | “上海机房”， “上海节点” |
| cn-shenzhen | 华南1（深圳） | 深圳，华南，南方 | “深圳机房”， “华南节点” |
| ap-southeast-1 | 新加坡 | 新加坡，东南亚 | “新加坡节点”， “海外机房” |

### 3.3 状态同义词映射表

| 正式状态 | 同义词 | 用户表达 | 含义 |
|---|---|---|---|
| Running | 运行中，正在运行，正常，在线，活动 | “运行中”， “好好的”， “在线” | 资源正常运行 |
| Stopped | 已停止，关机，停止，离线 | “已停止”， “关机了”， “停了” | 资源已停止 |
| Starting | 启动中，开机中，启动 | “启动中”， “正在开机” | 资源正在启动 |
| Stopping | 停止中，关机中，停止 | “停止中”， “正在关机” | 资源正在停止 |
| Pending | 创建中，部署中，初始化中 | “创建中”， “正在部署” | 资源正在创建 |

## 4. 实体属性知识库 (Attribute Knowledge)

### 4.1 核心属性分类

**标识属性 (Identification)**
- 资源ID (ResourceId): 唯一标识符
- 资源名称 (ResourceName): 用户友好的名称
- ARN (Aliyun Resource Name): 全局唯一资源定位符

**配置属性 (Configuration)**
- 规格类型 (InstanceType, DBInstanceClass): 如ecs.g6.large, rds.mysql.s2.large
- 容量 (DiskSize, DBInstanceStorage): 存储容量，单位GB/TB
- 镜像/引擎 (ImageId, Engine): 操作系统或数据库引擎版本
- 网络配置 (VSwitchId, SecurityGroupIds, IP地址)

**状态属性 (Status)**
- 运行状态 (Status): Running, Stopped等
- 健康状态 (HealthStatus): 健康检查结果
- 监控指标 (CPUUtilization, MemoryUsage, IOPS): 实时性能数据

**元数据属性 (Metadata)**
- 创建时间 (CreationTime)
- 过期时间 (ExpiredTime)
- 标签 (Tags): 键值对标签
- 资源组 (ResourceGroupId)

**成本属性 (Billing)**
- 计费方式 (InstanceChargeType): 包年包月(PrePaid)，按量付费(PostPaid)
- 付费周期 (Period)
- 费用 (每日/月度费用估算)

### 4.2 属性可见性与权限关系

| 属性类别 | 典型字段 | 用户角色可见性 | 说明 |
|---|---|---|---|
| 公开属性 | ResourceId, ResourceName, Status, Region | 所有用户 | 基础信息，无安全风险 |
| 受限属性 | IP地址，连接字符串，监控详情 | 开发者/运维 | 需要资源级权限 |
| 敏感属性 | 密码，AccessKey，证书，数据库密码 | 管理员/特定角色 | 需要RAM高级权限，通常脱敏显示 |
| 管理属性 | 费用详情，操作日志，审计记录 | 财务/管理员 | 需要账单或审计权限 |

### 4.3 属性展示优先级

**高优先级（默认展示）**
- 资源ID/名称
- 状态
- 地域/可用区
- 主要规格（如CPU/内存）
- 创建时间

**中优先级（按需展示）**
- 网络信息（IP，安全组）
- 存储信息（磁盘大小，类型）
- 标签
- 监控指标（当前值）

**低优先级（详细模式展示）**
- 详细配置参数
- 依赖关系
- 历史变更
- 成本明细

## 5. 实体状态与生命周期库 (State & Lifecycle)

### 5.1 标准状态机定义

**ECS实例状态机**

```text
创建中 (Pending)
    ↓
运行中 (Running) ←→ 停止中 (Stopping) → 已停止 (Stopped)
    ↑                         ↓
    └── 启动中 (Starting) ←──┘
    
特殊状态：
- 重启中 (Rebooting): Running → Rebooting → Running
- 重置中 (Resetting): 系统重置状态
- 过期 (Expired): 包年包月实例到期
- 已释放 (Released): 资源已删除
```

**RDS实例状态机**

```text
创建中 (Creating)
    ↓
运行中 (Running) ←→ 重启中 (Rebooting)
    ↓
迁移中 (Migrating)    SSL更新中 (SSLUpdating)
    ↓                     ↓
运行中                运行中
    
异常状态：
- 异常 (Error): 实例异常
- 锁定 (Locked): 因欠费等原因锁定
- 删除中 (Deleting): 正在删除
```
### 5.2 生命周期阶段与用户交互

| 生命周期阶段 | 典型状态 | 用户可执行操作 | 自动系统行为 |
|---|---|---|---|
| 规划阶段 | - | 查询规格，预估费用，选择地域 | 推荐配置，成本预估 |
| 创建阶段 | Creating, Pending | 监控创建进度，取消创建 | 异步创建，进度报告 |
| 运行阶段 | Running | 监控，配置变更，重启，备份 | 健康检查，自动备份，监控告警 |
| 维护阶段 | Stopped, Upgrading, Migrating | 数据迁移，版本升级，配置优化 | 维护窗口，变更控制 |
| 终止阶段 | Expired, Deleting, Released | 续费，数据备份，资源释放 | 到期提醒，数据保留策略 |

### 5.3 状态转换约束规则

**不允许的转换示例**

| 当前状态 | 不允许的操作 | 原因 |
|---|---|---|---|
| Creating | Stop, Restart | 实例尚未创建完成 |
| Stopped | CreateBackup（某些类型） | 实例关机时某些备份类型不可用 |
| Expired | Restart（自动拒绝） | 实例已过期需先续费 |

**依赖状态约束**
- 磁盘挂载约束：
  - Disk状态必须是 Available（而非 In_use 或 Attaching）
  - ECS状态必须是 Stopped（热插拔除外）

## 6. 实体关系上下文库 (Relationship Context)

### 6.1 阿里云核心资源关联图谱

```text
VPC                (核心网络枢纽)
├── contains
│   ├── VSwitch           (子网划分)
│   ├── RouteTable       （路由策略）
│   └── NATGateway       （网络地址转换）
├── connects (via Peer)
│   └── Another VPC      （对等连接）
├── accesses
│   └── Internet         （通过 NAT/EIP）
└── hosted_by
    ├── VPN Gateway       （VPN接入）
    └── Express Connect   （专线接入）

ECS Instance        （计算节点）
├── attached_to
│   ├── Disk             （块存储）
│   ├── Image            （系统镜像源）
│   └── Snapshot         （备份来源）
├── belongs_to
│   ├── VSwitch         （网络位置）
│   └── SecurityGroup   （安全策略）
├── bound_to
│   └── EIP             （公网访问）
└── monitored_by
    └── CloudMonitor    （监控指标）

RDS Instance        （数据服务）
├── belongs_to
│   ├── VSwitch         （网络隔离）
│   └── SecurityGroup   （数据库防火墙）
├── contains
│   ├── Database        （逻辑数据库）
│   ├── Account         （访问账号）
│   └── BackupSet       （备份集合）
├── replicates_to
│   └── ReadOnlyInstance（只读副本）
└── migrated_from
    └── On-premise DB   （上云迁移源）

SLB LoadBalancer    （流量入口）
├── listens_on
│   └── Listener        （协议端口配置）
├── forwards_to
│   └── BackendServer   （通常为ECS）
└── bound_to
    └── EIP/Domain      （公网访问入口）

ALB LoadBalancer    （应用层流量入口）
├── listens_on
│   └── Listener        （协议端口配置，支持HTTP/HTTPS/QUIC）
├── forwards_to
│   ├── ServerGroup     （服务器组，支持ECS/ENI/IP）
│   └── Rule            （转发规则，支持基于路径/域名/头部路由）
├── bound_to
│   └── EIP/Domain      （公网访问入口）
└── associated_with
    ├── Certificate     （SSL/TLS证书）
    └── ACL             （访问控制列表）

Redis Instance       （缓存服务）
├── belongs_to
│   ├── VSwitch         （网络隔离）
│   └── SecurityGroup   （访问控制）
├── cached_by
│   └── ECS/Application （被ECS或应用缓存）
├── replicated_to
│   └── ReadonlyInstance （只读副本）
└── backed_up_to
    └── Backup          （备份实例）

MongoDB Instance      （文档数据库）
├── belongs_to
│   ├── VSwitch         （网络隔离）
│   └── SecurityGroup   （访问控制）
├── contains
│   ├── Database        （逻辑数据库）
│   └── Account         （访问账号）
└── replicated_to
    └── SecondaryNode   （副本集节点）

RocketMQ Instance     （消息队列）
├── contains
│   ├── Topic           （消息主题）
│   ├── Group           （消费者组）
│   └── Subscription    （订阅关系）
├── published_by
│   └── ECS/Application （生产者）
└── consumed_by
    └── ECS/Application （消费者）

Kafka Instance        （消息流）
├── contains
│   ├── Topic           （消息主题）
│   ├── Partition       （分区）
│   └── Consumer Group  （消费者组）
├── produced_by
│   └── ECS/Application （生产者）
└── consumed_by
    └── ECS/Application （消费者）

FC Function           （Serverless函数）
├── belongs_to
│   └── Service         （函数服务）
├── triggered_by
│   ├── OSS Event       （OSS事件触发）
│   ├── Timer Trigger   （定时触发）
│   └── HTTP Trigger    （HTTP触发）
├── connected_to
│   ├── RDS             （访问数据库）
│   ├── Redis           （访问缓存）
│   └── RocketMQ/Kafka  （发送/接收消息）
└── monitored_by
    └── CloudMonitor    （监控指标）

OSS Bucket            （对象存储）
├── contains
│   └── Object          （对象文件）
├── accessed_by
│   ├── ECS             （ECS挂载访问）
│   └── FC Function     （FC函数触发）
├── replicated_to
│   └── Regional Bucket （跨区域复制）
└── backed_up_to
    └── Archive Bucket   （归档存储）

NAS FileSystem        （文件存储）
├── mounted_by
│   ├── ECS             （ECS挂载）
│   └── Container       （容器挂载）
├── contains
│   └── MountTarget     （挂载点）
└── backed_up_to
    └── Snapshot        （快照备份）

SLS Project           （日志服务）
├── contains
│   ├── Logstore        （日志库）
│   └── Dashboard       （监控大盘）
├── collects_from
│   ├── ECS             （主机日志）
│   └── FC Function     （函数日志）
└── analyzed_by
    └── Query/Alert     （查询分析/告警）

WAF Instance          （Web防火墙）
├── protects
│   ├── Domain          （域名防护）
│   └── IP Address      （IP防护）
├── forwards_to
│   ├── SLB/ALB         （负载均衡后端）
│   └── ECS             （源站服务器）
└── associated_with
    └── ACL/Policy      （访问控制策略）

DDoS Protection       （DDoS防护）
├── protects
│   ├── EIP             （EIP防护）
│   ├── SLB/ALB         （负载均衡防护）
│   └── IP Address      （IP防护）
└── forwards_to
    └── Origin Server   （源站服务器）

PolarDB Instance       （云原生数据库）
├── belongs_to
│   ├── VPC             （网络隔离）
│   ├── VSwitch         （子网位置）
│   └── SecurityGroup   （访问控制）
├── contains
│   ├── Database        （逻辑数据库）
│   ├── Account         （访问账号）
│   └── Backup          （备份集）
├── replicates_to
│   ├── ReadWriteCluster（读写分离集群）
│   └── ReadOnlyNode    （只读节点）
└── monitored_by
    └── CloudMonitor    （监控指标）

ACK Cluster           （容器服务）
├── belongs_to
│   ├── VPC             （网络隔离）
│   └── VSwitch         （子网位置）
├── contains
│   ├── NodePool        （节点池）
│   │   └── ECS Instance （ECS节点）
│   ├── Pod             （容器实例）
│   ├── Service         （服务）
│   └── Application     （应用）
├── attached_to
│   ├── SLB/ALB         （负载均衡暴露服务）
│   └── NAS             （持久化存储）
├── connects_to
│   ├── RDS             （访问数据库）
│   ├── Redis           （访问缓存）
│   └── RocketMQ/Kafka  （消息队列）
└── monitored_by
    ├── CloudMonitor    （集群监控）
    └── SLS             （日志采集）
```

### 6.2 关系类型定义

| 关系类型 | 正式名称 | 方向性 | 示例 | API查询路径 |
|---|---|---|---|---|
| contains | 包含关系 | 单向 | VPC contains VSwitch | VPC → DescribeVSwitches |
| attached_to | 挂载关系 | 双向 | Disk attached_to ECS | ECS → DescribeDisks (filter by InstanceId) |
| belongs_to | 属于关系 | 单向 | ECS belongs_to VSwitch | ECS → NetworkInterfaces → VSwitchId |
| connected_to | 连接关系 | 双向 | ECS connected_to RDS (via network) | 需间接查询：检查安全组规则、VPC内网互通 |
| depends_on | 依赖关系 | 单向 | Application depends_on Database | 业务逻辑，通常通过标签或架构文档定义 |
| backed_up_to | 备份到 | 单向 | Disk backed_up_to Snapshot | Disk → DescribeSnapshots (filter by SourceDiskId) |
| monitored_by | 被监控 | 单向 | ECS monitored_by CloudMonitor | ECS → DescribeMetricList (namespace: acs_ecs) |
| scaled_with | 随...伸缩 | 关联 | ECS scaled_with SLB (in scaling group) | 通过ESS伸缩组关联查询 |
| tagged_with | 标签关联 | 多对多 | Resources tagged_with env:prod | DescribeResourcesByTag |
| routes_to | 路由转发 | 单向 | ALB routes_to ServerGroup (via Rule) | ALB → DescribeRules → DescribeServerGroups |
| load_balances | 负载均衡 | 双向 | ALB load_balances ECS Servers | ALB → DescribeServerGroups (BackendServers列表) |
| cached_by | 缓存关系 | 双向 | Redis cached_by ECS Application | Redis → 查询连接IP列表 |
| published_by | 消息发布 | 单向 | RocketMQ published_by ECS Producer | RocketMQ → 查看生产者Group |
| consumed_by | 消息消费 | 单向 | Kafka consumed_by ECS Consumer | Kafka → 查看消费者组 |
| triggered_by | 触发关系 | 单向 | FC triggered_by OSS Event | FC → DescribeTriggers |
| protects | 保护关系 | 单向 | WAF protects Domain | WAF → 查看防护域名列表 |
| mounted_by | 挂载关系 | 单向 | NAS mounted_by ECS | NAS → DescribeMountTargets |

### 6.3 关系强度与推理权重

| 关系强度等级 | 描述 | 示例 | 推理权重 | 是否自动关联查询 |
|---|---|---|---|---|
| 强关系 | 物理或必要逻辑连接，资源无法独立运行 | ECS挂载系统盘，RDS位于VSwitch内 | 0.9-1.0 | 是，默认包含 |
| 中关系 | 常见业务连接，典型架构模式 | ECS连接RDS，SLB后端挂ECS | 0.6-0.8 | 是，建议包含 |
| 弱关系 | 可选或间接关联，依赖特定场景 | ECS使用OSS存储，资源共享标签 | 0.3-0.5 | 否，按需查询 |
| 临时关系 | 动态或暂时性关联 | 临时EIP绑定，迁移中间状态 | 0.1-0.2 | 否，除非明确查询 |

## 7. 实体验证规则库 (Validation Rules)

### 7.1 格式验证规则

**资源ID格式验证**

| 资源类型 | 验证规则 | 错误提示 | 自动纠正建议 |
|---|---|---|---|
| ECS InstanceId | 必须匹配 i-[a-z0-9]{17} | “ECS实例ID格式错误” | 提示标准格式，建议通过列表选择 |
| RDS DBInstanceId | 必须匹配 rm-[a-z0-9]{17} | “RDS实例ID格式错误” | 检查是否混淆了实例ID和连接字符串 |
| VPC VpcId | 必须匹配 vpc-[a-z0-9]{17} | “VPC ID格式错误” | - |
| RegionId | 必须在预定义地域列表中 | “地域不存在或不可用” | 提供最近似地域建议（如`cn-beijing`建议`cn-beijing`） |

**名称与标签验证**

| 项目 | 验证规则 | 示例无效输入 | 修正建议 |
|---|---|---|---|
| 资源名称 | 长度2-128字符，允许字母数字- _ | a（太短）， 包含空格 | 自动截断，替换非法字符 |
| 标签Key | 长度1-128字符，允许字母数字+ . : / = + @ - | key with spaces | 替换空格为_或- |
| 标签Value | 长度0-128字符，同Key规则 | 值包含,逗号 | 去除逗号或其他禁用字符 |
| IP地址 | 有效IPv4格式 | 256.256.256.256 | 提示IP范围错误 |

### 7.2 存在性与权限验证

**预检查询（执行前验证）**

| 验证类型 | 检查方法 | 失败处理 | 用户提示 |
|---|---|---|---|
| 资源存在性 | 调用 Describe[Resource] 检查返回条目 | 降级为列表查询或请求确认 | “未找到ID为i-xxx的ECS实例，是否查询名称包含‘xxx’的资源？” |
| 地域可用性 | 检查用户账号在该地域是否激活服务 | 切换默认地域或提示激活 | “您在上海地域未激活ECS服务，切换到杭州地域查询或前往控制台激活” |
| 权限验证 | 通过RAM策略模拟或预检API | 提示权限不足，建议申请权限 | “您没有查看安全组规则的权限，请联系管理员添加DescribeSecurityGroups权限” |
| 服务配额 | 检查查询是否可能超出API限流或资源数量限制 | 分页查询，或提示精简查询条件 | “您的查询可能返回超过1000个实例，建议添加过滤条件” |

### 7.3 业务逻辑验证

**状态相关约束**

| 约束场景 | 验证规则 | 违反时处理 | 示例 |
|---|---|---|---|
| 操作状态约束 | 某些操作要求特定状态（如重启需Running状态） | 检查当前状态，提示先达到所需状态 | “实例当前为Stopped状态，无法重启，请先启动” |
| 依赖资源状态 | 操作依赖的其他资源需就绪 | 检查依赖链，提供状态概览 | “无法挂载磁盘：磁盘状态需为Available，当前为In_use” |
| 时间窗口约束 | 某些操作只能在维护窗口执行 | 检查维护窗口设置，建议时间 | “当前非维护窗口，变更将在下次维护窗口自动执行” |

**配置一致性验证**

| 验证点 | 检查规则 | 不一致处理 | 业务影响 |
|---|---|---|---|
| 网络连通性 | 检查安全组、网络ACL、路由表配置是否允许通信 | 生成连通性诊断报告 | ECS与RDS间网络不通 |
| 规格兼容性 | 检查资源间规格匹配（如磁盘类型与实例系列） | 提示兼容性问题建议 | 高性能磁盘挂载到低规格实例可能无法发挥性能 |
| 版本兼容性 | 检查软件/引擎版本兼容性 | 提供升级/降级建议 | 应用版本与数据库版本不兼容 |
| 成本优化 | 检查资源配置是否存在明显浪费 | 提供优化建议 | 长期低利用率的高配实例 |

### 7.4 验证规则执行顺序
1. 格式验证：识别阶段，立即反馈
2. 存在性预检：执行前，异步轻量级检查
3. 权限验证：执行前，必要检查
4. 业务逻辑验证：执行计划生成时
5. 运行时验证：API调用时的错误处理

## 8. 用户历史与偏好库 (User History & Preferences)

### 8.1 用户查询历史模式

**历史记录结构**

```yaml
用户查询历史记录:

  - 查询ID: session_20260116_103000_001
    原始查询: "查看我的Web服务器"
    解析结果: {intent: "SIMPLE_QUERY", service: "ECS", filters: [{tag: "role:web"}]}
    执行结果: 找到3台实例 [i-001, i-002, i-003]
    用户反馈: 选择了 i-001
    时间: 2026-01-16 10:30:00
    上下文: 用户正在排查网站访问慢的问题
```

**模式提取维度**

| 维度 | 记录内容 | 应用场景 |
|---|---|---|
| 时间模式 | 用户通常在哪些时间段查询什么类型资源 | 预加载缓存，提前准备 |
| 服务偏好 | 用户最常查询的服务（ECS/RDS/SLB等） | 默认服务优先级 |
| 地域偏好 | 用户最常操作的地域分布 | 默认地域设置 |
| 资源偏好 | 用户通常关注的特定资源（如某台核心数据库） | 快速访问列表 |
| 操作习惯 | 用户喜欢详细输出还是简洁输出，偏好表格还是图表 | 个性化结果格式化 |

### 8.2 用户角色建模

| 角色类型 | 典型查询模式 | 关注资源类型 | 输出偏好 | 权限范围 |
|---|---|---|---|---|
| 运维工程师 | 批量状态检查，性能诊断，配置审计 | ECS, SLB, 监控告警 | 详细诊断报告，表格对比 | 全资源查看，部分变更权限 |
| 开发工程师 | 应用部署状态，连接信息，日志查询 | ECS, RDS, 容器服务 | 简洁连接信息，状态指示灯 | 项目内资源，只读为主 |
| 架构师 | 全栈架构拓扑，成本分析，性能瓶颈 | 跨服务关联，成本报告 | 关系图，趋势图表，对比分析 | 全账号查看，无变更权限 |
| 财务管理员 | 成本统计，资源利用率，预算分析 | 账单，资源使用率，标签 | 数据图表，汇总表格，成本趋势 | 账单和成本管理权限 |
| 安全审计员 | 权限审计，安全配置，合规检查 | 安全组，RAM策略，操作日志 | 审计报告，风险清单，合规对比 | 只读审计权限 |

### 8.3 个性化配置与默认值

**用户级默认值**

| 配置项 | 默认值来源 | 优先级 | 示例 |
|---|---|---|---|
| 默认地域 | 1) 用户最近操作地域 2) 资源最多地域 3) 系统默认(杭州) | 用户显式设置 > 历史推断 > 系统默认 | 用户80%操作在北京 → 默认cn-beijing |
| 默认项目/标签 | 用户最近使用的标签过滤条件 | 基于历史会话 | 用户常查 env:prod → 建议过滤生产环境 |
| 输出格式偏好 | 用户历史结果交互行为 | 统计用户点击“详细”还是“简洁”频率 | 用户总点开详细视图 → 默认输出详细模式 |
| 时间范围默认值 | 用户查询的时间范围习惯 | 按查询类型区分 | 监控查询默认“最近24小时”，成本查询默认“本月” |

**组织级共享上下文**

| 上下文类型 | 共享范围 | 应用方式 | 示例 |
|---|---|---|---|
| 组织资源标签规范 | 全组织 | 自动识别和推荐标签过滤 | 标签`project:`前缀规范自动识别 |
| 环境定义 | 项目组内 | 环境标签智能映射 | 生产环境 → env:prod + project:电商 |
| 命名规范 | 部门内 | 资源名称解析辅助 | 名称`web-prod-01`自动分解为`服务:web`, `环境:prod`, `序号:01` |
| 成本中心映射 | 财务部门 | 成本查询自动分组 | 按`cost_center`标签自动聚合成本 |

### 8.4 学习与适应机制

**反馈学习循环**

   用户查询 → 系统解析 → 用户交互（确认/纠正/选择） → 记录反馈
      ↑                                           ↓
      └─── 更新用户模型 ←── 模式分析 ←── 历史聚合 ←───┘


**学习触发场景**

| 学习类型 | 触发条件 | 学习内容 | 更新频率 |
|---|---|---|---|
| 纠错学习 | 用户明确纠正解析结果 | 同义词映射，实体识别模式 | 实时 |
| 偏好学习 | 用户在多个选项中选择 | 输出格式，默认过滤条件，结果排序 | 会话结束 |
| 模式发现 | 用户重复类似查询 | 查询模式，服务组合，时间规律 | 周期性分析 |
| 异常检测 | 用户查询与历史模式显著不同 | 新业务场景识别，异常告警 | 实时标记 |

**隐私与边界**
- 用户历史数据默认保留30天
- 敏感操作记录脱敏存储
- 用户可随时清除个人历史
- 组织级模式仅聚合匿名数据

